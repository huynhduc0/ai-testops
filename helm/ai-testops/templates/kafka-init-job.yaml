apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-topic-init
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "ai-testops.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: kafka-topic-init
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-kafka
        image: busybox:1.28
        command: 
          - sh
          - -c
          - |
            echo "Waiting for Kafka to be ready..."
            until nc -z {{ .Values.kafka.name }}.{{ .Values.namespace }}.svc.cluster.local {{ .Values.kafka.service.port }}; do
              echo "Kafka not ready, sleeping..."
              sleep 5
            done
            echo "Kafka is ready!"
            sleep 10
      containers:
      - name: kafka-topic-creator
        image: "{{ .Values.kafka.image.repository }}:{{ .Values.kafka.image.tag }}"
        command:
          - sh
          - -c
          - |
            echo "Creating Kafka topic: test_run_queue"
            /opt/kafka/bin/kafka-topics.sh --create \
              --bootstrap-server {{ .Values.kafka.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.kafka.service.port }} \
              --topic test_run_queue \
              --partitions 3 \
              --replication-factor 1 \
              --if-not-exists || echo "Topic might already exist, continuing..."
            
            echo "Listing topics:"
            /opt/kafka/bin/kafka-topics.sh --list \
              --bootstrap-server {{ .Values.kafka.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.kafka.service.port }}
