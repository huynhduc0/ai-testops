{{- if .Values.keda.enabled }}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: consumer-kafka-scaler
  namespace: {{ .Values.namespace }}
  labels:
    app: {{ .Values.consumer.name }}
    {{- include "ai-testops.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "6"
    # Use server-side apply to avoid KEDA validation warnings
    argocd.argoproj.io/compare-result: "ignore-excess"
spec:
  scaleTargetRef:
    name: {{ .Values.consumer.name }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  minReplicaCount: {{ .Values.keda.consumer.minReplicas }}
  maxReplicaCount: {{ .Values.keda.consumer.maxReplicas }}
  triggers:
  - type: kafka
    metadata:
      bootstrapServers: {{ .Values.kafka.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.kafka.service.port }}
      consumerGroup: {{ .Values.keda.consumer.consumerGroup }}
      topic: {{ .Values.keda.consumer.topic }}
      lagThreshold: {{ .Values.keda.consumer.lagThreshold | quote }}
      offsetResetPolicy: latest
      allowIdleConsumers: "true"
{{- end }}
