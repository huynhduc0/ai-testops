name: Release Helm Chart

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1951599, v2a3b4c5, etc.)

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Create gh-pages branch if not exists
        run: |
          if ! git ls-remote --heads origin gh-pages | grep gh-pages; then
            echo "Creating gh-pages branch..."
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# Helm Charts Repository" > README.md
            git add README.md
            git commit -m "Initialize gh-pages branch"
            git push origin gh-pages
            git checkout main
          else
            echo "gh-pages branch already exists"
          fi

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: helm
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Update index.html on gh-pages to trigger ArgoCD
        run: |
          git fetch origin gh-pages
          git checkout gh-pages
          
          # Create or update index.html with current timestamp and unique ID
          cat > index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AI TestOps Helm Charts</title>
              <meta http-equiv="refresh" content="0;url=https://github.com/${{ github.repository }}">
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      height: 100vh;
                      margin: 0;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                  }
                  .container {
                      text-align: center;
                      padding: 2rem;
                      background: rgba(255, 255, 255, 0.1);
                      border-radius: 10px;
                      backdrop-filter: blur(10px);
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>AI TestOps Helm Charts</h1>
                  <p>Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>
                  <p>Release: ${{ github.ref_name }}</p>
                  <p>Run ID: ${{ github.run_id }}</p>
                  <p>Redirecting to repository...</p>
              </div>
              <!-- Unique ID: ${{ github.run_id }}-$(date +%s) -->
          </body>
          </html>
          EOF
          
          git add index.html
          git diff --cached
          git commit -m "Update index.html for release ${{ github.ref_name }} - Run ${{ github.run_id }}" || echo "No changes to commit"
          git push origin gh-pages || echo "Push failed"
