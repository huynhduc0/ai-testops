name: CI/CD Pipeline

on:
  push:
    branches:
      - main

concurrency:
  group: ci-cd-pipeline
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Generate version tag
      id: version
      run: |
        VERSION=${GITHUB_SHA::7}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
    
    - name: Check for changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          django:
            - 'canvas/**'
            - 'api_tests/**'
            - 'home/**'
            - 'templates/**'
            - 'static/**'
            - 'Dockerfile'
            - 'requirements.txt'
            - 'manage.py'
          consumer:
            - 'test-execute-consumer/**'
          helm_infra:
            - 'helm/testops-infra/**'
          helm_publisher:
            - 'helm/testops-publisher/**'
          helm_consumer:
            - 'helm/testops-consumer/**'
          helm_postdeploy:
            - 'helm/testops-postdeploy/**'
          argocd:
            - 'argocd/**'

    - name: Bump Helm chart versions
      id: chart_version
      run: |
        echo "Checking for chart changes..."
        
        # Initialize flags
        BUMP_INFRA=false
        BUMP_PUBLISHER=false
        BUMP_CONSUMER=false
        BUMP_POSTDEPLOY=false
        
        # Bump publisher if Django code or Dockerfile changes
        if [ "${{ steps.changes.outputs.django }}" == "true" ]; then
          BUMP_PUBLISHER=true
        fi
        
        # Bump consumer if consumer code changes
        if [ "${{ steps.changes.outputs.consumer }}" == "true" ]; then
          BUMP_CONSUMER=true
        fi
        
        # Bump specific charts if their helm templates change
        if [ "${{ steps.changes.outputs.helm_infra }}" == "true" ]; then
          BUMP_INFRA=true
        fi
        
        if [ "${{ steps.changes.outputs.helm_publisher }}" == "true" ]; then
          BUMP_PUBLISHER=true
        fi
        
        if [ "${{ steps.changes.outputs.helm_consumer }}" == "true" ]; then
          BUMP_CONSUMER=true
        fi
        
        if [ "${{ steps.changes.outputs.helm_postdeploy }}" == "true" ]; then
          BUMP_POSTDEPLOY=true
        fi
        
        # Bump all charts if argocd configs change (affects all deployments)
        if [ "${{ steps.changes.outputs.argocd }}" == "true" ]; then
          BUMP_INFRA=true
          BUMP_PUBLISHER=true
          BUMP_CONSUMER=true
          BUMP_POSTDEPLOY=true
        fi
        
        # Bump testops-infra
        if [ "$BUMP_INFRA" == "true" ]; then
          CURRENT_VERSION=$(grep '^version:' helm/testops-infra/Chart.yaml | awk '{print $2}')
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEW_PATCH=$((patch + 1))
          INFRA_VERSION="${major}.${minor}.${NEW_PATCH}"
          sed -i "s/^version:.*/version: $INFRA_VERSION/" helm/testops-infra/Chart.yaml
          echo "INFRA_VERSION=$INFRA_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped testops-infra: $CURRENT_VERSION -> $INFRA_VERSION"
        else
          INFRA_VERSION=$(grep '^version:' helm/testops-infra/Chart.yaml | awk '{print $2}')
          echo "INFRA_VERSION=$INFRA_VERSION" >> $GITHUB_OUTPUT
        fi
        
        # Bump testops-publisher
        if [ "$BUMP_PUBLISHER" == "true" ]; then
          CURRENT_VERSION=$(grep '^version:' helm/testops-publisher/Chart.yaml | awk '{print $2}')
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEW_PATCH=$((patch + 1))
          PUBLISHER_VERSION="${major}.${minor}.${NEW_PATCH}"
          sed -i "s/^version:.*/version: $PUBLISHER_VERSION/" helm/testops-publisher/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.VERSION }}\"/" helm/testops-publisher/Chart.yaml
          echo "PUBLISHER_VERSION=$PUBLISHER_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped testops-publisher: $CURRENT_VERSION -> $PUBLISHER_VERSION"
        else
          PUBLISHER_VERSION=$(grep '^version:' helm/testops-publisher/Chart.yaml | awk '{print $2}')
          echo "PUBLISHER_VERSION=$PUBLISHER_VERSION" >> $GITHUB_OUTPUT
        fi
        
        # Bump testops-consumer
        if [ "$BUMP_CONSUMER" == "true" ]; then
          CURRENT_VERSION=$(grep '^version:' helm/testops-consumer/Chart.yaml | awk '{print $2}')
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEW_PATCH=$((patch + 1))
          CONSUMER_VERSION="${major}.${minor}.${NEW_PATCH}"
          sed -i "s/^version:.*/version: $CONSUMER_VERSION/" helm/testops-consumer/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.VERSION }}\"/" helm/testops-consumer/Chart.yaml
          echo "CONSUMER_VERSION=$CONSUMER_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped testops-consumer: $CURRENT_VERSION -> $CONSUMER_VERSION"
        else
          CONSUMER_VERSION=$(grep '^version:' helm/testops-consumer/Chart.yaml | awk '{print $2}')
          echo "CONSUMER_VERSION=$CONSUMER_VERSION" >> $GITHUB_OUTPUT
        fi
        
        # Bump testops-postdeploy
        if [ "$BUMP_POSTDEPLOY" == "true" ]; then
          CURRENT_VERSION=$(grep '^version:' helm/testops-postdeploy/Chart.yaml | awk '{print $2}')
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEW_PATCH=$((patch + 1))
          POSTDEPLOY_VERSION="${major}.${minor}.${NEW_PATCH}"
          sed -i "s/^version:.*/version: $POSTDEPLOY_VERSION/" helm/testops-postdeploy/Chart.yaml
          echo "POSTDEPLOY_VERSION=$POSTDEPLOY_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped testops-postdeploy: $CURRENT_VERSION -> $POSTDEPLOY_VERSION"
        else
          POSTDEPLOY_VERSION=$(grep '^version:' helm/testops-postdeploy/Chart.yaml | awk '{print $2}')
          echo "POSTDEPLOY_VERSION=$POSTDEPLOY_VERSION" >> $GITHUB_OUTPUT
        fi
    
    - name: Build and push Django app image
      if: steps.changes.outputs.django == 'true'
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ai-testops:${{ steps.version.outputs.VERSION }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops:v${{ steps.chart_version.outputs.CHART_VERSION }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops:latest
        platforms: linux/amd64,linux/arm64
    
    - name: Build and push Consumer image
      if: steps.changes.outputs.consumer == 'true'
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./test-execute-consumer/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:${{ steps.version.outputs.VERSION }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:v${{ steps.chart_version.outputs.CHART_VERSION }}
          ${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:latest
        platforms: linux/amd64,linux/arm64
    
    - name: Update image tags in values.yaml
      run: |
        if [ "${{ steps.changes.outputs.django }}" == "true" ]; then
          echo "Updating Django app image tag to ${{ steps.version.outputs.VERSION }}"
          sed -i "/djangoApp:/,/service:/ s|tag:.*|tag: \"${{ steps.version.outputs.VERSION }}\"|" helm/testops-publisher/values.yaml
        fi
        
        if [ "${{ steps.changes.outputs.consumer }}" == "true" ]; then
          echo "Updating Consumer image tag to ${{ steps.version.outputs.VERSION }}"
          sed -i "/consumer:/,/service:/ s|tag:.*|tag: \"${{ steps.version.outputs.VERSION }}\"|" helm/testops-consumer/values.yaml
        fi
        
    - name: Set git identity
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
    - name: Commit and push changes
      if: steps.changes.outputs.django == 'true' || steps.changes.outputs.consumer == 'true' || steps.changes.outputs.helm_infra == 'true' || steps.changes.outputs.helm_publisher == 'true' || steps.changes.outputs.helm_consumer == 'true' || steps.changes.outputs.helm_postdeploy == 'true' || steps.changes.outputs.argocd == 'true'
      run: |
        git add helm/*/values.yaml helm/*/Chart.yaml helm/*/Chart.lock
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        git commit -m "chore: bump charts (infra:${{ steps.chart_version.outputs.INFRA_VERSION }}, publisher:${{ steps.chart_version.outputs.PUBLISHER_VERSION }}, consumer:${{ steps.chart_version.outputs.CONSUMER_VERSION }}) [skip ci]"
        git pull --rebase
        git push origin main
    
    - name: Create and push Git tags
      if: (steps.changes.outputs.django == 'true' || steps.changes.outputs.consumer == 'true' || steps.changes.outputs.helm_infra == 'true' || steps.changes.outputs.helm_publisher == 'true' || steps.changes.outputs.helm_consumer == 'true' || steps.changes.outputs.helm_postdeploy == 'true' || steps.changes.outputs.argocd == 'true') && github.ref == 'refs/heads/main'
      run: |
        # Main release tag
        RELEASE_TAG="testops-${{ steps.version.outputs.VERSION }}"
        if git rev-parse "$RELEASE_TAG" >/dev/null 2>&1; then
          echo "Tag $RELEASE_TAG already exists"
        else
          git tag -a "$RELEASE_TAG" -m "Release ${{ steps.version.outputs.VERSION }}"
          git push origin "$RELEASE_TAG"
        fi
        
        # Tag for infra chart
        if git rev-parse "testops-infra-${{ steps.chart_version.outputs.INFRA_VERSION }}" >/dev/null 2>&1; then
          echo "Tag testops-infra-${{ steps.chart_version.outputs.INFRA_VERSION }} already exists"
        else
          git tag -a "testops-infra-${{ steps.chart_version.outputs.INFRA_VERSION }}" -m "Release testops-infra ${{ steps.chart_version.outputs.INFRA_VERSION }}"
          git push origin "testops-infra-${{ steps.chart_version.outputs.INFRA_VERSION }}"
        fi
        
        # Tag for publisher chart
        if git rev-parse "testops-publisher-${{ steps.chart_version.outputs.PUBLISHER_VERSION }}" >/dev/null 2>&1; then
          echo "Tag testops-publisher-${{ steps.chart_version.outputs.PUBLISHER_VERSION }} already exists"
        else
          git tag -a "testops-publisher-${{ steps.chart_version.outputs.PUBLISHER_VERSION }}" -m "Release testops-publisher ${{ steps.chart_version.outputs.PUBLISHER_VERSION }}"
          git push origin "testops-publisher-${{ steps.chart_version.outputs.PUBLISHER_VERSION }}"
        fi
        
        # Tag for consumer chart
        if git rev-parse "testops-consumer-${{ steps.chart_version.outputs.CONSUMER_VERSION }}" >/dev/null 2>&1; then
          echo "Tag testops-consumer-${{ steps.chart_version.outputs.CONSUMER_VERSION }} already exists"
        else
          git tag -a "testops-consumer-${{ steps.chart_version.outputs.CONSUMER_VERSION }}" -m "Release testops-consumer ${{ steps.chart_version.outputs.CONSUMER_VERSION }}"
          git push origin "testops-consumer-${{ steps.chart_version.outputs.CONSUMER_VERSION }}"
        fi
        
        # Tag for postdeploy chart
        if git rev-parse "testops-postdeploy-${{ steps.chart_version.outputs.POSTDEPLOY_VERSION }}" >/dev/null 2>&1; then
          echo "Tag testops-postdeploy-${{ steps.chart_version.outputs.POSTDEPLOY_VERSION }} already exists"
        else
          git tag -a "testops-postdeploy-${{ steps.chart_version.outputs.POSTDEPLOY_VERSION }}" -m "Release testops-postdeploy ${{ steps.chart_version.outputs.POSTDEPLOY_VERSION }}"
          git push origin "testops-postdeploy-${{ steps.chart_version.outputs.POSTDEPLOY_VERSION }}"
        fi
    
    - name: Install Helm
      if: (steps.changes.outputs.django == 'true' || steps.changes.outputs.consumer == 'true' || steps.changes.outputs.helm == 'true' || steps.changes.outputs.argocd == 'true') && github.ref == 'refs/heads/main'
      uses: azure/setup-helm@v3
      with:
        version: v3.13.0
    
    - name: Run chart-releaser to update index.yaml
      if: (steps.changes.outputs.django == 'true' || steps.changes.outputs.consumer == 'true' || steps.changes.outputs.helm_infra == 'true' || steps.changes.outputs.helm_publisher == 'true' || steps.changes.outputs.helm_consumer == 'true' || steps.changes.outputs.helm_postdeploy == 'true' || steps.changes.outputs.argocd == 'true') && github.ref == 'refs/heads/main'
      uses: helm/chart-releaser-action@v1.6.0
      with:
        charts_dir: helm
      env:
        CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    
    - name: Verify chart-releaser output
      if: (steps.changes.outputs.django == 'true' || steps.changes.outputs.consumer == 'true' || steps.changes.outputs.helm_infra == 'true' || steps.changes.outputs.helm_publisher == 'true' || steps.changes.outputs.helm_consumer == 'true' || steps.changes.outputs.helm_postdeploy == 'true' || steps.changes.outputs.argocd == 'true') && github.ref == 'refs/heads/main'
      run: |
        echo "Checking chart-releaser output directory..."
        ls -la .cr-release-packages/ 2>/dev/null || echo "No .cr-release-packages directory"
        echo "Checking gh-pages branch for index.yaml..."
        git fetch origin gh-pages
        git show origin/gh-pages:index.yaml | head -20 || echo "index.yaml not found on gh-pages"
    
    - name: Update index.html on gh-pages to trigger ArgoCD
      if: (steps.changes.outputs.django == 'true' || steps.changes.outputs.consumer == 'true' || steps.changes.outputs.helm_infra == 'true' || steps.changes.outputs.helm_publisher == 'true' || steps.changes.outputs.helm_consumer == 'true' || steps.changes.outputs.helm_postdeploy == 'true' || steps.changes.outputs.argocd == 'true') && github.ref == 'refs/heads/main'
      run: |
        # Stash any local changes before switching branches
        git stash
        git fetch origin gh-pages
        git checkout gh-pages
        
        # Create index.html that dynamically reads index.yaml
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>TestOps Helm Charts</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            code { background: #f4f4f4; padding: 2px 5px; }
            ul { list-style: none; padding: 0; }
            li { padding: 5px 0; }
          </style>
        </head>
        <body>
          <h1>TestOps Helm Repository</h1>
          <p>Repository: <code>https://huynhduc0.github.io/ai-testops</code></p>
          <p>Updated: <span id="timestamp">-</span></p>
          <h2>Charts:</h2>
          <ul id="chart-list">
            <li>Loading chart versions...</li>
          </ul>
          <script>
            // Parse index.yaml and display chart versions
            fetch('index.yaml')
              .then(response => response.text())
              .then(data => {
                const timestamp = new Date().toUTCString();
                document.getElementById('timestamp').textContent = timestamp;
                
                // Simple YAML parser for chart entries
                const lines = data.split('\n');
                const charts = {};
                let currentChart = null;
                
                for (let i = 0; i < lines.length; i++) {
                  const line = lines[i];
                  if (line.startsWith('  - name: ')) {
                    currentChart = line.replace('  - name: ', '').trim();
                    charts[currentChart] = [];
                  } else if (currentChart && line.match(/^\s+- version:/)) {
                    const version = line.split(':')[1].trim().replace(/"/g, '');
                    if (!charts[currentChart].includes(version)) {
                      charts[currentChart].push(version);
                    }
                  }
                }
                
                // Display latest version for each chart
                const chartList = document.getElementById('chart-list');
                chartList.innerHTML = '';
                for (const [chart, versions] of Object.entries(charts)) {
                  if (versions.length > 0) {
                    const latestVersion = versions[versions.length - 1];
                    chartList.innerHTML += `<li>${chart}: <code>${latestVersion}</code></li>`;
                  }
                }
              })
              .catch(error => {
                console.error('Error loading index.yaml:', error);
                document.getElementById('chart-list').innerHTML = '<li>Error loading chart versions</li>';
              });
          </script>
        </body>
        </html>
        EOF
        
        git add index.html
        git commit -m "Update index.html (infra:${{ steps.chart_version.outputs.INFRA_VERSION }}, publisher:${{ steps.chart_version.outputs.PUBLISHER_VERSION }}, consumer:${{ steps.chart_version.outputs.CONSUMER_VERSION }}, postdeploy:${{ steps.chart_version.outputs.POSTDEPLOY_VERSION }})" || echo "No changes"
        git push origin gh-pages
        
        git checkout main
    
    - name: Create GitHub Release
      if: (steps.changes.outputs.django == 'true' || steps.changes.outputs.consumer == 'true' || steps.changes.outputs.helm_infra == 'true' || steps.changes.outputs.helm_publisher == 'true' || steps.changes.outputs.helm_consumer == 'true' || steps.changes.outputs.helm_postdeploy == 'true' || steps.changes.outputs.argocd == 'true') && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: testops-${{ steps.version.outputs.VERSION }}
        name: Release testops-${{ steps.version.outputs.VERSION }}
        body: |
          ## üì¶ Chart Versions
          - **testops-infra**: `${{ steps.chart_version.outputs.INFRA_VERSION }}`
          - **testops-publisher**: `${{ steps.chart_version.outputs.PUBLISHER_VERSION }}`
          - **testops-consumer**: `${{ steps.chart_version.outputs.CONSUMER_VERSION }}`
          - **testops-postdeploy**: `${{ steps.chart_version.outputs.POSTDEPLOY_VERSION }}`
          
          ## üê≥ Docker Images
          - `${{ secrets.DOCKER_USERNAME }}/ai-testops:${{ steps.version.outputs.VERSION }}`
          - `${{ secrets.DOCKER_USERNAME }}/ai-testops-consumer:${{ steps.version.outputs.VERSION }}`
          
          ## üîÑ Updated Components
          ${{ steps.changes.outputs.django == 'true' && '- ‚úÖ Django app (publisher)\n' || '' }}${{ steps.changes.outputs.consumer == 'true' && '- ‚úÖ Consumer\n' || '' }}${{ steps.changes.outputs.helm == 'true' && '- ‚úÖ Helm charts\n' || '' }}${{ steps.changes.outputs.argocd == 'true' && '- ‚úÖ ArgoCD config\n' || '' }}
          
          **Commit**: `${{ steps.version.outputs.VERSION }}`
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
